# Forecasting Analysis UI Implementation

## Overview

This document describes the implementation of the forecasting analysis UI components for the ResortChain International Palm Case Study. The implementation uses **point-in-time forecast matching** to accurately compare forecasts against actual transaction data.

## Key Improvement

**Previous approach (INCORRECT):** Aggregated forecasts to monthly level before comparing to actuals.

**New approach (CORRECT):** For each transaction, finds the forecast with start_date closest to the transaction date, then calculates accuracy metrics. This ensures we're comparing forecasts that were actually available at the time of the transaction.

## Components Created

### 1. Core UI Components (`components/blocks/`)

#### `forecast_metrics_explainer.tsx`
- **Purpose**: Explains forecast accuracy metrics (MAE, MAPE, Bias, Bias %)
- **Features**:
  - Card-based layout with color-coded badges
  - Detailed descriptions and interpretations for each metric
  - Real-world examples to aid understanding
  - Fully responsive design

#### `forecast_accuracy_table.tsx`
- **Purpose**: Displays detailed accuracy metrics by forecast method and category
- **Features**:
  - Sortable table (sorted by MAPE - best to worst)
  - Color-coded MAPE values (green = excellent, blue = good, amber = acceptable, red = poor)
  - Formatted currency values with proper separators
  - Bias direction indicators (â†‘ overforecasting, â†“ underforecasting, â†’ neutral)
  - Top 3 performers highlighted with background color
  - Legend showing MAPE accuracy ranges

#### `forecast_winner_callout.tsx`
- **Purpose**: Highlights the best performing forecast model
- **Features**:
  - Trophy icon and success-styled callout
  - Key metrics grid (MAPE, MAE, Bias, Count)
  - Dynamic interpretation text based on accuracy levels
  - Formatted currency display

#### `monthly_forecast_chart.tsx`
- **Purpose**: Visualizes monthly forecast comparison across all methods
- **Features**:
  - Grouped bar chart with distinct patterns for each series:
    - Actual: Solid bars
    - ML Model: Diagonal lines (/)
    - Statistical Model: Reverse diagonal (\\)
    - Foundation Model: Crosshatch (x)
    - Static: Horizontal lines (âˆ’)
    - User Predictions: Dots (Â·)
  - Interactive tooltips with formatted values
  - Responsive design with Recharts
  - Handles missing data gracefully (only shows series with data)

#### `forecast_comparison.tsx`
- **Purpose**: Main dashboard combining all forecast components
- **Features**:
  - Client-side data fetching from API routes
  - Loading state management
  - Four main sections:
    1. Metrics explanation
    2. Best model callout
    3. Accuracy comparison table
    4. Monthly chart visualization
  - Key takeaways summary section

### 2. UI Foundation Components (`components/ui/`)

#### `table.tsx`
- **Purpose**: Reusable table component following shadcn/ui patterns
- **Components**: Table, TableHeader, TableBody, TableRow, TableHead, TableCell, TableCaption
- **Styling**: Consistent with the rest of the UI using Tailwind CSS

### 3. API Routes (`app/api/`)

#### `forecast-accuracy/route.ts`
- **Endpoint**: `/api/forecast-accuracy`
- **Returns**: JSON array of accuracy metrics (with Avg_Forecast_Age)
- **Source**: `scripts/datasets/raw/forecast_accuracy_metrics.json`

#### `forecast-best-method/route.ts`
- **Endpoint**: `/api/forecast-best-method`
- **Returns**: JSON object with best method details
- **Source**: `scripts/datasets/raw/forecast_best_method.json`

#### `forecast-daily/route.ts` (**NEW**)
- **Endpoint**: `/api/forecast-daily`
- **Returns**: JSON array of daily forecast data (Jan-Aug 2025)
- **Source**: `scripts/datasets/raw/forecast_daily_reconstruction.csv`
- **Note**: Complete daily time series with zeros for days without transactions

#### `forecast-monthly/route.ts`
- **Endpoint**: `/api/forecast-monthly`
- **Returns**: JSON array of monthly forecast comparisons
- **Source**: `scripts/datasets/raw/monthly_forecast_comparison.csv`
- **Note**: Aggregated from daily data for consistency

### 4. Data Files (`scripts/datasets/raw/`)

#### Generated by Notebook:
- `forecast_accuracy_metrics.json` - Detailed accuracy metrics by category and method (includes Avg_Forecast_Age)
- `forecast_best_method.json` - Best performing model information
- `forecast_daily_reconstruction.csv` - **NEW**: Daily actual vs forecast data (Jan-Aug 2025)
- `monthly_forecast_comparison.csv` - Monthly aggregation from daily data

#### Key Changes:
- Added `Avg_Forecast_Age` column showing average days between forecast creation and transaction
- New daily reconstruction file with complete time series (fills zeros for days without transactions)
- Monthly data is now aggregated from daily data for consistency

## Analysis Methodology

### Point-in-Time Forecast Matching

The forecasting analysis implements a robust point-in-time matching algorithm:

1. **Parse System Forecasts** (Cell 5)
   - Extract daily forecasts from system_forecasts.csv
   - Each forecast covers a 13-week period from start_date to end_date
   - Parse JSON forecast_amounts to get daily predictions

2. **Match Transactions to Forecasts** (Cell 6)
   - For each transaction:
     - Find all forecasts where start_date â‰¤ transaction_date â‰¤ end_date
     - Select the forecast with start_date CLOSEST to transaction_date
     - This ensures we use the most recent forecast available
   - Calculate forecast_age = (transaction_date - forecast_start_date)

3. **Calculate Accuracy Metrics** (Cell 7)
   - Group by (forecast_method, category)
   - MAE: Mean Absolute Error in currency
   - MAPE: Mean Absolute Percentage Error (excludes zero actuals)
   - Bias: Average over/underforecast amount
   - Bias_Pct: Bias as percentage of mean actual
   - Avg_Forecast_Age: Average days between forecast creation and use

4. **Daily Reconstruction** (Cell 8)
   - Generate complete Jan 1 - Aug 31, 2025 date range
   - For each date and category:
     - Get actual amount (0 if no transaction)
     - Find best forecast for each method (most recent start_date)
     - Include user forecasts (excluding dismissed/cancelled)
   - Result: Complete daily time series for visualization

5. **Export Data** (Cell 9)
   - Accuracy metrics â†’ JSON for table component
   - Best method â†’ JSON for callout component
   - Daily reconstruction â†’ CSV for charts
   - Monthly aggregation â†’ CSV for summary views

6. **Visualizations** (Cell 10)
   - Accuracy by method (bar chart)
   - Forecast age vs error (scatter plot)
   - MAPE heatmap (category Ã— method)
   - Key statistics summary

## Data Flow

```
Jupyter Notebook (scripts/main.ipynb)
    â†“ (point-in-time matching)
Matched Forecasts DataFrame
    â†“ (aggregate & export)
JSON/CSV Files (scripts/datasets/raw/)
    â†“ (served by)
API Routes (app/api/forecast-*)
    â†“ (fetched by)
React Components (components/blocks/forecast_*)
    â†“ (displayed in)
Main Page (app/page.tsx)
```

## Integration with Main App

The forecast comparison section is integrated into the main page (`app/page.tsx`) at the bottom, after the existing analysis sections. It's separated with a border and spacing for visual clarity.

```tsx
<div className="w-full flex flex-col gap-4 mt-16 pt-16 border-t">
  <ForecastComparison />
</div>
```

## TypeScript Types

### AccuracyMetric
```typescript
type AccuracyMetric = {
  Category: string;
  Forecast_Method: string;
  MAE: number;
  MAPE: number;
  Bias: number;
  Bias_Pct: number;
  Count: number;
}
```

### BestMethodInfo
```typescript
type BestMethodInfo = {
  best_method: string;
  mape: number;
  mae: number;
  bias_pct: number;
  count: number;
}
```

### MonthlyForecastData
```typescript
type MonthlyForecastData = {
  month: string;
  category: string;
  actual: number;
  forecast_ml_model?: number;
  forecast_statistical_model?: number;
  forecast_foundation_model?: number;
  forecast_static?: number;
  forecast_user?: number;
}
```

## Styling Approach

- **Design System**: Tailwind CSS + shadcn/ui
- **Color Palette**: 
  - Actual: Indigo (#6366f1)
  - ML Model: Red (#ef4444)
  - Statistical: Green (#10b981)
  - Foundation: Purple (#8b5cf6)
  - Static: Amber (#f59e0b)
  - User: Pink (#ec4899)
- **Accessibility**: Patterns + colors for better distinction
- **Responsive**: Mobile-first design with proper breakpoints

## Running the Analysis

### Step 1: Generate Data
Run the Jupyter notebook to generate the forecast analysis data:

```bash
cd scripts

# Option A: Run in Jupyter Lab/Notebook
jupyter notebook main.ipynb
# Then run cells 2-10:
#   Cell 2: Load datasets
#   Cell 3: Data exploration
#   Cells 5-10: Forecasting analysis (new implementation)

# Option B: Execute via command line (requires jupyter)
jupyter nbconvert --to notebook --execute main.ipynb --inplace
```

**What gets generated:**
- `forecast_accuracy_metrics.json` - Accuracy table data with Avg_Forecast_Age
- `forecast_best_method.json` - Best model winner callout data
- `forecast_daily_reconstruction.csv` - Complete daily time series (Jan-Aug 2025)
- `monthly_forecast_comparison.csv` - Monthly aggregated data

### Step 2: Start Development Server
```bash
cd ..  # Back to project root
npm run dev
```

The server will start on http://localhost:3000 (or 3001 if 3000 is in use).

### Step 3: View Results
Navigate to the development server URL and scroll to the "ðŸ“Š Forecasting Analysis" section at the bottom.

**What you'll see:**
1. Metrics explanation card
2. Best model winner callout
3. Detailed accuracy comparison table (with forecast age)
4. Monthly forecast chart with patterns
5. Key takeaways summary

## Key Features

### 1. **Comprehensive Metrics**
- MAE, MAPE, Bias, and Bias % for each forecast method
- Category-level granularity
- Count of observations for statistical significance

### 2. **Visual Clarity**
- Color-coded accuracy levels
- Pattern-based chart differentiation
- Clear labels and formatting

### 3. **Performance**
- Client-side data fetching with loading states
- Optimized API routes with error handling
- Efficient CSV parsing

### 4. **Maintainability**
- Modular component structure
- Reusable UI components
- Type-safe with TypeScript
- Clear separation of concerns

## Future Enhancements

1. **Data Refresh**: Add a refresh button to reload data without page refresh
2. **Filtering**: Allow filtering by category or time period
3. **Export**: Add CSV/PDF export functionality
4. **Drill-down**: Click on rows to see detailed analysis
5. **Comparison**: Side-by-side comparison of multiple methods
6. **Real-time**: WebSocket integration for live forecast updates

## Troubleshooting

### Issue: "Loading forecast data..." persists
- **Check**: Ensure the JSON/CSV files exist in `scripts/datasets/raw/`
- **Solution**: Run the Jupyter notebook to generate the data files

### Issue: API routes return 500 errors
- **Check**: Console logs for specific error messages
- **Common**: File path issues or malformed JSON
- **Solution**: Verify file paths and data format

### Issue: Charts not displaying patterns
- **Check**: Browser SVG pattern support
- **Solution**: Use a modern browser (Chrome, Firefox, Safari, Edge)

### Issue: Table shows no data
- **Check**: Network tab in browser DevTools for API responses
- **Solution**: Ensure API routes are working and returning data

## Dependencies

- **Next.js 14+**: App router, API routes
- **React 18+**: Client components, hooks
- **Recharts**: Chart visualization
- **Tailwind CSS**: Styling
- **shadcn/ui**: UI component library
- **Lucide React**: Icons

## File Structure

```
palm-case-study/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ forecast-accuracy/route.ts
â”‚   â”‚   â”œâ”€â”€ forecast-best-method/route.ts
â”‚   â”‚   â””â”€â”€ forecast-monthly/route.ts
â”‚   â””â”€â”€ page.tsx (updated)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ blocks/
â”‚   â”‚   â”œâ”€â”€ forecast_accuracy_table.tsx
â”‚   â”‚   â”œâ”€â”€ forecast_comparison.tsx
â”‚   â”‚   â”œâ”€â”€ forecast_metrics_explainer.tsx
â”‚   â”‚   â”œâ”€â”€ forecast_winner_callout.tsx
â”‚   â”‚   â””â”€â”€ monthly_forecast_chart.tsx
â”‚   â””â”€â”€ ui/
â”‚       â””â”€â”€ table.tsx
â””â”€â”€ scripts/
    â””â”€â”€ datasets/
        â””â”€â”€ raw/
            â”œâ”€â”€ forecast_accuracy_metrics.json
            â”œâ”€â”€ forecast_best_method.json
            â””â”€â”€ monthly_forecast_comparison.csv
```

## Conclusion

The forecasting analysis UI has been successfully implemented following the specification. All components are functional, responsive, and integrated into the main application. The implementation provides clear insights into forecast accuracy and helps identify the best performing models for ResortChain International.

